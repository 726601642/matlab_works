% Example 5.3     32-channel PQMF for MPEG-1 Audio Coder
%
% Reference:      Analysis prototype filter is extracted from Table C.1 (pp. 68-69)
%                 from "Information technology - Coding of moving pictures and associated
%                 audio for digital storage media at up to 1,5 Mbits/s - Part3: Audio,"
%                 ISO/IEC 11172-3: 1993
%
% by Lee, Gan, and Kuo, 2008
% Subband Adaptive Filtering: Theory and Implementation
% Publisher: John Wiley and Sons, Ltd

addpath '..\Common';         % Functions in Common folder
clear all; close all;

% Prototype filter h is extracted from MPEG-1 audio coder

% First half of the prototype filter

C(  1)= 0.0;         C(  2)=-0.000000477; C(  3)=-0.000000477; C(  4)=-0.000000477 ;
C(  5)=-0.000000477; C(  6)=-0.000000477; C(  7)=-0.000000477; C(  8)=-0.000000954 ;
C(  9)=-0.000000954; C( 10)=-0.000000954; C( 11)=-0.000000954; C( 12)=-0.000001431 ;
C( 13)=-0.000001431; C( 14)=-0.000001907; C( 15)=-0.000001907; C( 16)=-0.000002384 ;
C( 17)=-0.000002384; C( 18)=-0.000002861; C( 19)=-0.000003338; C( 20)=-0.000003338 ;
C( 21)=-0.000003815; C( 22)=-0.000004292; C( 23)=-0.000004768; C( 24)=-0.000005245 ;
C( 25)=-0.000006199; C( 26)=-0.000006676; C( 27)=-0.000007629; C( 28)=-0.000008106 ;
C( 29)=-0.000009060; C( 30)=-0.000010014; C( 31)=-0.000011444; C( 32)=-0.000012398 ;
C( 33)=-0.000013828; C( 34)=-0.000014782; C( 35)=-0.000016689; C( 36)=-0.000018120 ;
C( 37)=-0.000019550; C( 37)=-0.000021458; C( 39)=-0.000023365; C( 40)=-0.000025272 ;
C( 41)=-0.000027657; C( 42)=-0.000030041; C( 43)=-0.000032425; C( 44)=-0.000034809 ;
C( 45)=-0.000037670; C( 46)=-0.000040531; C( 47)=-0.000043392; C( 48)=-0.000046253 ;
C( 49)=-0.000049591; C( 50)=-0.000052929; C( 51)=-0.000055790; C( 52)=-0.000059605 ;
C( 53)=-0.000062943; C( 54)=-0.000066280; C( 55)=-0.000070095; C( 56)=-0.000073433 ;
C( 57)=-0.000076771; C( 58)=-0.000080585; C( 59)=-0.000083923; C( 60)=-0.000087261 ;
C( 61)=-0.000090599; C( 62)=-0.000093460; C( 63)=-0.000096321; C( 64)=-0.000099182 ;
C( 65)=-0.000101566; C(66)= -0.000103951; C( 67)=-0.000105858; C( 68)=-0.000107288 ;
C( 69)=-0.000108242; C( 70)=-0.000108719; C( 71)=-0.000108719; C( 72)=-0.000108242 ;
C( 73)=-0.000106812; C( 74)=-0.000105381; C( 75)=-0.000102520; C( 76)=-0.000099182 ;
C( 77)=-0.000095367; C( 78)=-0.000090122; C( 79)=-0.000084400; C( 80)=-0.000077724 ;
C( 81)=-0.000069618; C( 82)=-0.000060558; C( 83)=-0.000050545; C( 84)=-0.000039577 ;
C( 84)=-0.000027180; C( 85)=-0.000013828; C( 86)= 0.000000954; C( 88)= 0.000017166 ;
C( 89)= 0.000034332; C( 90)= 0.000052929; C( 91)= 0.000072956; C( 92)= 0.000093937 ;
C( 93)= 0.000116348; C( 94)= 0.000140190; C( 95)= 0.000165462; C( 96)= 0.000191212 ;
C( 97)= 0.000218868; C( 98)= 0.000247478; C( 99)= 0.000277042; C(100)= 0.000307560 ;
C(101)= 0.000339031; C(102)= 0.000371456; C(103)= 0.000404358; C(104)= 0.000438213 ;
C(105)= 0.000472546; C(106)= 0.000507355; C(107)= 0.000542164; C(108)= 0.000576973 ;
C(109)= 0.000611782; C(110)= 0.000646591; C(111)= 0.000680923; C(112)= 0.000714302 ;
C(113)= 0.000747204; C(114)= 0.000779152; C(115)= 0.000809669; C(116)= 0.000838757 ;
C(117)= 0.000866413; C(118)= 0.000891685; C(119)= 0.000915051; C(120)= 0.000935555 ;
C(121)= 0.000954151; C(122)= 0.000968933; C(123)= 0.000980854; C(124)= 0.000989437 ;
C(125)= 0.000994205; C(126)= 0.000995159; C(127)= 0.000991821; C(128)= 0.000983715 ;
C(129)= 0.000971317; C(130)= 0.000953674; C(131)= 0.000930786; C(132)= 0.000902653 ;
C(133)= 0.000868797; C(134)= 0.000829220; C(135)= 0.000783920; C(136)= 0.000731945 ;
C(137)= 0.000674248; C(138)= 0.000610352; C(139)= 0.000539303; C(140)= 0.000462532 ;
C(141)= 0.000378609; C(142)= 0.000288486; C(143)= 0.000191689; C(144)= 0.000088215 ;
C(145)=-0.000021458; C(146)=-0.000137329; C(147)=-0.000259876; C(148)=-0.000388145 ;
C(149)=-0.000522137; C(150)=-0.000661850; C(151)=-0.000806808; C(152)=-0.000956535 ;
C(153)=-0.001111031; C(154)=-0.001269817; C(155)=-0.001432419; C(156)=-0.001597881 ;
C(157)=-0.001766682; C(158)=-0.001937389; C(159)=-0.002110004; C(160)=-0.002283096 ;
C(161)=-0.002457142; C(162)=-0.002630711; C(163)=-0.002803326; C(164)=-0.002974033 ;
C(165)=-0.003141880; C(166)=-0.003306866; C(167)=-0.003467083; C(168)=-0.003622532 ;
C(169)=-0.003771782; C(170)=-0.003914356; C(171)=-0.004048824; C(172)=-0.004174709 ;
C(173)=-0.004290581; C(174)=-0.004395962; C(175)=-0.004489899; C(176)=-0.004570484 ;
C(177)=-0.004638195; C(178)=-0.004691124; C(179)=-0.004728317; C(180)=-0.004748821 ;
C(181)=-0.004752159; C(182)=-0.004737377; C(183)=-0.004703045; C(184)=-0.004649162 ;
C(185)=-0.004573822; C(186)=-0.004477024; C(187)=-0.004357815; C(188)=-0.004215240 ;
C(189)=-0.004049301; C(190)=-0.003858566; C(191)=-0.003643036; C(192)=-0.003401756 ;
C(193)=-0.003134727; C(194)=-0.002841473; C(195)=-0.002521515; C(196)=-0.002174854 ;
C(197)=-0.001800537; C(198)=-0.001399517; C(199)=-0.000971317; C(200)=-0.000515938 ;
C(201)=-0.000033379; C(202)= 0.000475883; C(203)= 0.001011848; C(204)= 0.001573563 ;
C(205)= 0.002161503; C(206)= 0.002774239; C(207)= 0.003411293; C(208)= 0.004072189 ;
C(209)= 0.004756451; C(210)= 0.005462170; C(211)= 0.006189346; C(212)= 0.006937027 ;
C(213)= 0.007703304; C(214)= 0.008487225; C(215)= 0.009287834; C(216)= 0.010103703 ;
C(217)= 0.010933399; C(218)= 0.011775017; C(219)= 0.012627602; C(220)= 0.013489246 ;
C(221)= 0.014358521; C(222)= 0.015233517; C(223)= 0.016112804; C(224)= 0.016994476 ;
C(225)= 0.017876148; C(226)= 0.018756866; C(227)= 0.019634247; C(228)= 0.020506859 ;
C(229)= 0.021372318; C(230)= 0.022228718; C(231)= 0.023074150; C(232)= 0.023907185 ;
C(233)= 0.024725437; C(234)= 0.025527000; C(235)= 0.026310921; C(236)= 0.027073860 ;
C(237)= 0.027815342; C(238)= 0.028532982; C(239)= 0.029224873; C(240)= 0.029890060 ;
C(241)= 0.030526638; C(242)= 0.031132698; C(243)= 0.031706810; C(244)= 0.032248020 ;
C(245)= 0.032754898; C(246)= 0.033225536; C(247)= 0.033659935; C(248)= 0.034055710 ;
C(249)= 0.034412861; C(250)= 0.034730434; C(251)= 0.035007000; C(252)= 0.035242081 ;
C(253)= 0.035435200; C(254)= 0.035586357; C(255)= 0.035694122; C(256)= 0.035758972 ;
C(257)= 0.035780907; 

% Complete other half of the prototype filter and plot frequency response

h = [C C(256:-1:1)];
figure, plot(h); title('Impulse response of prototype filter'); grid on;
xlabel('Samples');
ylabel('Amplitude');
axis([0 513 -0.01 0.04]);
NFFT = 1024;                        % FFT side
Fs = 48000;                         % Sampling frequency
H = fft(h,NFFT);
f = Fs/2*linspace(0,1,(NFFT/2)+1);
figure; plot(f,20*log10(abs(H(1:(NFFT/2)+1))));
grid; title('Frequency response of prototype filter');
xlabel('Frequency (Hz)');
ylabel('Magnitude in dB');

% Create 32-band PQMF filter bank

nbands = 32;
len = length(h);
[H,G] = make_bank_3(h,nbands);      % Create filter banks
dist_alias(H,G,nbands);             % Compute distortion and aliasing

% Plot frequency response of filter bank

[Hz,w] = FreqResp(H',NFFT);         % Compute frequency response
Hz = Hz.';
figure; subplot(3,1,[1 2]), hold on;
for k = 1:nbands
    if mod(k,2)==0
        plot(w/pi,20*log10(abs(Hz(k,:))+eps));
    else
        plot(w/pi,20*log10(abs(Hz(k,:))+eps),':');
    end
end
axis([0 1 -120 10]); box on; ylabel('Gain (dB)'); 
title('Frequency response of 32-band PQMF filter bank');

% Distortion function

Tz = sum(abs(Hz).^2);
subplot(3,1,3); plot(w/pi,10*log10(Tz));
xlabel('Frequency,\omega (\pi)'); ylabel('Gain (dB)');
axis([0 1 6.01 6.03]);
title('Combined distortion response');

